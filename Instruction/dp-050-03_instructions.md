# DP 050 – SQL Workloads から Azure への移行

## ラボ 3 – SQL Workloads を Azure Virtual Machine 内の SQL Server に移行する

**推定時間:** 60 分

**前提条件:** このラボでは、実行する前提条件の手順はありません。

**ラボ ファイル:** このラボにはラボ ファイルがありません。

## ラボの概要

受講者は、最初に、オンプレミスの SQL Server 2008 R2 インスタンスから仮想マシンで実行されている SQL Server 2017 への移行に使用する移行プロセスを評価します。次に、移行を実行し、Data Migration Assistant を使用してデータベースを移動します。最後に、移行の成功を評価します。

## ラボの目的

この課題を完了すると、次のことができるようになります。

- Windows Server 2017 を実行する仮想マシンを Azure にデプロイする。
- Azure ストレージ アカウントおよびファイル共有を作成する。
- SQL Server 2008 R2 データベースを Azure VM の SQL Server に移行する。

## シナリオ

あなたは、Adventureworks 社の上級データベース管理リーダーであり、データ モダナイゼイション プロジェクトを実行する準備をしています。一連のデータベースを、Azure 仮想マシン内の SQL Server に移行するために必要な環境を準備し、Data Migration Assistant を使用してテスト移行を実行することになります。

## 演習 1: Windows Server 2017 を実行する仮想マシンを Azure にデプロイする。

この演習では、Azure Portal を使用して、Azure 上に新しい仮想マシンを作成します。

**推定時間:** 20 分

このエクササイズのタスクは次のとおりです。

1. Azure Portal 内に、新しい仮想マシンを作成する

### Provision a SQL Server 2017 仮想マシンのプロビジョニング

> [!注]
> ホスト型ラボ環境でこのラボを実行している場合は、そのラボ環境内で次の手順を実行します。

1. [Azure portal](https://portal.azure.com) で、「**リソースの作成**」 を選択します。
1. 「マーケットプレイス」 検索ボックスに、「**SQL Server 2017 on Windows Server 2019**」と入力し、Enter キーを押します。「**すべての結果を表示**」 で、「**SQL Server 2017 on Windows Server 2019**」を選択します。
1. 「**プランの選択**」 ドロップダウンリストで、「**無料の SQL Server ライセンス**」 を選択します。「**SQL Server 2017 Developer on Windows Server 2019**」 をクリックし、「**作成**」を選択します。
1. 「**仮想マシンの作成**」 ウィザードの 「**基本**」 ページで、次の値を入力し、「**次へ**」 を選択します。**ディスク \>**:

    | プロパティ | 値 |
    | --- | --- |
    | サブスクリプション | サブスクリプションを選択する |
    | リソース グループ | **DP-050-Training** という名前で新しいリソース グループを作成します。 |
    | 仮想マシン名 | sql2017vm |
    | リージョン | 近くのリージョンを選択します |
    | 可用性オプション | インフラストラクチャの冗長性は必要ありません |
    | イメージ | 無料の SQL Server ライセンス: Windows Server 2019 - Gen1 の SQL Server 2017 Developer |
    | Azure Spot インスタンス | いいえ |
    | サイズ | Standard_D2_v2 |
    | ユーザー名 | sqladmin |
    | パスワード | Pa55w.rdPa55w.rd |
    | パスワードの確認 | Pa55w.rdPa55w.rd |
    | パブリック受信ポート | 選択したポートを許可する |
    | 受信ポートの選択 | RDP (3389) |
    | 既存の Windows ライセンスを使用しますか?  | いいえ |
    
1. **ディスク** ページで、既定の設定値を受け入れてから、**次へ:** を選択します。**Networking \>**。
1. **ネットワーク** ページで、既定の設定値を受け入れてから、**次へ:** を選択します。**Management \>**。
1. 「**管理**」 ページの 「**ブート診断**」 リストで、「**無効**」 を選択し、「**次へ**」 を選択します。**Advanced \>**。
1. **詳細** ページで、既定の設定値を受け入れてから、**次へ:** を選択します。**SQL Server の設定 \>**。
1. 「**SQL Server の設定**」 ページで、これらの設定値を入力 し、「**レビュー + 作成**」 を選択します。

    | プロパティ | 値 |
    | --- | --- |
    | SQL 接続 | パブリック（インターネット） |
    | ポート | 1433 |
    | SQL 認証 | 「有効化」 |
    | 「ログイン名」 | sqladmin |
    | パスワード | Pa55w.rdPa55w.rd |
    | Azure Key Vault の統合 | Disable |

1. 「**レビュー + 作成**」 ページで、「**作成**」 を選択します。

    > [!注]
    > このプロセスの完了には 10分くらいかる場合があります。

1. デプロイが完了したら、**「リソースに移動」** を選択します。
1. お使いの VM の **パブリック IP アドレス** を見つけて記録します。このアドレスは後で必要になります。
1. 「**DNS 名**」 の隣で、「**構成**」 を選択します。
1. 「**DNS 名ラベル（オプション）**」 テキストボックスに、一意の DNS 名を入力して記録します。

    例: sql2017vmxxxx.centralus.cloudapp.azure.com

1. **「保存」** を選択します。

結果: この演習を完了すると、Azure Virtual Machine で SQL Server 2017 インスタンスが実行されます。

## 演習 2: Azure ストレージ アカウントおよびファイル共有を作成する

この演習では、Azure Portal を使用して、Azure 上に新しいストレージ アカウントを作成します。

**推定時間:** 約 15 分

この演習の主なタスクは次のとおりです。

1. Azure ストレージ アカウントを作成します。
1. セキュリティで Azure ストレージ アカウントにファイル共有を作成します。

### Azure Storage アカウントを作成する

1. [Azure portal](https://portal.azure.com) で、「**リソースの作成**」 を選択します。
1. 「**Marketplace を検索**」 テキスト ボックスに「**ストレージ アカウント**」と入力し、**Enter** キーを押します。
1. 「**すべての結果を表示**」 で 「**ストレージ アカウント**」 を選択し、「**作成**」 を選択します。
1. **ストレージ アカウントの作成**ウィザードの 「**基本**」 ページで、次の値を入力します。

    | プロパティ | 値 |
    | --- | --- |
    | サブスクリプション | サブスクリプションを選択します |
    | リソース グループ | DP-050 トレーニング |
    | ストレージ アカウント名 | **dp050storagexxxx** (xxxx) は乱数の文字 |
    | 場所 | 仮想マシンに使用したもののと同じ場所を選択する |
    | パフォーマンス | Standard |
    | アカウントの種類 | StorageV2 (汎用 v2) |
    | レプリケーション | ローカル冗長ストレージ (LRS) |

    > [!注]
    > 使用するストレージ アカウント名をしっかり書き留めておきます。この名前は、ラボにて後で使用します。

1. 「**確認および作成**」 を選択します。
1. 「**レビュー + 作成**」 ページで、「**作成**」 を選択します。

    > [!注]
    > この展開には数分かかる場合があります。

1. VM デプロイが完了したら、**「リソースに移動」** を選択します。
1. 「**設定**」 の 「**アクセス キー**」 を選択します。
1. 「**アクセス キー**」 ページで、「**キーを表示する**」 を選択し、**key1** の下の 「**キー**」 テキストボックスの内容を書き留めます。

### ファイル共有を作成する

1. ストレージアカウントページの左側のメニューの 「**ファイル サービス**」 で、「**ファイル共有**」 を選択します。
1. 「**ファイル共有**」セクションで、「**＋ファイル共有**」を選択します。
1. 「**新しいファイル共有**」 ページで、次の値を入力します。

    | プロパティ | 値 |
    | --- | --- |
    | 名前 | backupshare |
    | クォータ | 200 GiB |

1. **「作成」** を選択します。

結果: これで、SQL Server データベースのバックアップ ファイルの共有アクセス場所として使用される Azure ファイル シェア が正常に作成されました。次の演習では、共有場所にアクセスするために SQL インスタンスを構成します。

## 演習 3: SQL Server インスタンスの接続を作成して、Azure ファイル共有に接続します

この演習では、オンプレミスサーバーと新しい Azure VM の両方で Azure ファイル共有にアクセスするように SQL Server 環境を構成します。

**推定時間:** 約 10 分

この演習の主なタスクは次のとおりです。

1. ネットワーク ドライブをマッピングして SQL 管理スタジオからファイル共有を登録する
1. ファイル共有に接続する。

### SQL Management Studio にサーバー インスタンスを登録する

1. 教室環境で実行されている **LON-DEV-01** 仮想マシンにサインインします。ユーザー名は **administrator**、パスワードは **Pa55w.rd** です。
1. **SQL Management Studio** を起動してから、ローカル インスタンス（LONDON）に接続します。
1. SQL Management Studio Object Explorer で、「**接続**」を選択してから、「**データベース エンジン**」を選択します。
1. 「**サーバーに接続する**」 ダイアログで、次の値を入力し、「**接続**」 を選択します。

    | プロパティ | 値 |
    | --- | --- |
    | サーバー名 | Azure の SQL 2017 VM の完全修飾ドメイン名または IP アドレスを入力します。例: **sql2017vmxxx.centralus.cloudapp.azure.com** |
    | Authentication | SQL Server |
    | ログイン | sqladmin |
    | パスワード | Pa55w.rdPa55w.rd |

### オンプレミスの SQL インスタンスをファイル共有に接続します

> [!注]
> SQL Server がファイル共有にあるドライブ文字に接続できるようにするには、SQL Server Management Studio で `xp_cmdshell` を実行してネットワーク ドライブをマップし、SQL サービス アカウントが共有にアクセスできるようにする必要があります。データ移行アシスタントは、SQL サービス アカウントを使用してデータベースをバックアップします。セキュリティ上の理由から、SQL Server サービス アカウントのコマンド ライン アクセスを制限する必要があります。デフォルトでは、SQL コマンド ラインは無効になっています。

1. オンプレミスの SQL Server で接続を構成するには、SQL Management Studio の**オブジェクト エクスプローラー**で、**LONDON** サーバーを右クリックし、「**新しいクエリ**」 を選択します。
1. 次の Transact-SQL コードを入力します。

    ```sql
    EXECUTE sp_configure 'show advanced options', 1;
    RECONFIGURE;
    EXECUTE sp_configure 'xp_cmdshell', 1;
    RECONFIGURE;
    GO
    EXECUTE xp_cmdshell 'net use U: \\<storageaccountname>.file.core.windows.net\backupshare /persistent:Yes /u:Azure\<storageaccountname> <storageaccountkey>';
    EXECUTE xp_cmdshell 'dir U:';
    ```

1. クエリ テキストで、 `<storageaccountname>` を前に作成したストレージ アカウントの名前に置き換えます。名前は 2 か所に入力する必要があります。
1. `<storageaccountkey>` をストレージ アカウント用に書き留めたプライマリ アクセス キーに置き換えます。
1. クエリを実行し、結果にエラー メッセージがないことを確認します。

    > [!注]
    > SQL コードは、ネットワーク ドライブ U:を Azure のストレージ アカウントにマップします。ただし、これは SQL Service アカウントのコンテキストで行われるため、ファイル エクスプローラーで、または `net use` コマンドを使用したときに U: ドライブは表示されません。

1. Labfiles フォルダにクエリを **MapNetworkDrive.sql**として保存
1. 次のクエリを実行して、新しいクエリ ウィンドウを開始し、LONDON SQLServer で `xp_cmdshell` を無効にします。

    ```sql
    EXECUTE sp_configure 'xp_cmdshell', 0;
    RECONFIGURE;
    ```

1. すべてのクエリ ウィンドウを閉じ、どのファイルも保存しないでください。

### Azure VMSQL インスタンスをファイル共有に接続します。

1. Azure VM SQL Server で接続を構成するには、**オブジェクト エクスプローラー**で、Azure の SQL Server を右クリックし、「**接続**」 を選択します。
1. 「**サーバーに接続**」 ダイアログの 「**パスワード**」 テキストボックスに「**Pa55w.rdPa55w.rd**」と入力し、「**接続**」を選択します。
1. 「**ファイル**」 メニューで、「**開く/ファイル**」 を選択し、上記で保存した **MapNetworkDrive.sql** ファイルを開きます。
1. クエリ ウィンドウの下部にあるステータスバーで、Azure VM に接続していることを確認します。
1. Azure VM で U: ドライブをマップするには、クエリを実行し、結果にエラーメッセージがないことを確認します。
1. 次のクエリを実行して、新しいクエリ ウィンドウを開始し、`xp_cmdshell` を無効にします。

    ```sql
    EXECUTE sp_configure 'xp_cmdshell', 0;
    RECONFIGURE;
    ```

1. SQL Server Management Studio を閉じます。

## 演習 4: SQL Server Data Migration Assistant を使用したデータベース移行の実行

この演習では、データをオンプレミスの SQL Server から Azure の VM に移行します。

**推定時間:** 約 10 分

この演習の主なタスクは次のとおりです。

1. データベースを Data Migration Assistant で移行する
1. データベースの正常な移行を検証する。

### Data Migration Assistant を使用して SQL データベースを移行する

1. **LON-DEV-01** 仮想マシンで、**Microsoft Data Migration Assistant** を開き、「**+**」 を選択します。
1. 「**新規**」 セクションで、次の値を選択します。

    | プロパティ | 値 |
    | --- | --- |
    | プロジェクト タイプ | 移行 |
    | プロジェクト名 | Azure VM への移行 |
    | ソース サーバー名 | SQL Server |
    | ターゲット サーバー名 | Azure Virtual Machines 上の SQL Server |

1. **「作成」** を選択します。
1. 「**ソースとターゲットを指定する**」 ページの 「**ソースサーバーの詳細**」 で、次の値を入力します。

    | プロパティ | 値 |
    | --- | --- |
    | サーバー名 | localhost |
    | 認証タイプ | Windows 認証 |
    | 暗号化接続 | いいえ |
    | 「サーバー証明書を信頼する」 | はい |

1. 「**ターゲットサーバーの詳細**」 で、次の値を入力します。

    | プロパティ | 値 |
    | --- | --- |
    | サーバー名 | Azure の仮想マシンの IP アドレスまたは DNS 名を入力します |
    | 認証タイプ | SQL Server の認証 |
    | ユーザー名 | sqladmin |
    | パスワード | Pa55w.rdPa55w.rd |
    | 暗号化接続 | はい |
    | 「サーバー証明書を信頼する」 | はい |

1. **「次へ」** をクリックします。
1. 「**データベースの追加**」 ページで、**AdventureWorks** と **AdventureWorksLT2008TR2** を除くすべてのデータベースの選択を解除します。
1. 「**共有場所**」 テキストボックスに「**U:\\**」と入力し、「**次へ**」を選択します。
1. **ログインの選択**ウィンドウを確認します。移行するログインはありません。**StartMigration** を選択します。

    > [!注]
    > すべてのデータベースは、AzureStorage ファイル共有の共有ネットワーク ドライブにバックアップされます。

1. 移行プロセスを監視します。
1. 移行が完了したら、Data Migration Assistant を閉じます。

### 正常な移行の検証

1. **LON-DEV-01** 仮想マシンで、**SQL Management Studio** を開きます。
1. 「**サーバーに接続**」 ダイアログの 「**サーバー名**」 リストで、Azure VM の IP アドレスまたは DNS 名を選択します。
1. 「**パスワード**」 テキスト ボックスに「**Pa55w.rdPa55w.rd**」と入力し、「**接続**」 を接続します。
1. オブジェクト エクスプローラーで、「**データベース**」 リストを展開します。
1. **AdventureWorks** データベースが正常に移行されたことを確認します。
1. 「**ファイル**」 メニューの **「新規/クエリを現在の接続で実行」** を選択します。
1. 次のクエリを入力して実行して、各データベースのデータベース互換性レベルを検証します。

    ```sql
    SELECT name, compatibility_level FROM sys.databases
    ```

1. **Adventureworks** データベースに対するデータベース互換レベルを変更するには、次のクエリを使用します。

    ```sql
    ALTER DATABASE AdventureWorks
    SET COMPATIBILITY_LEVEL = 110;
    GO
    ```

1. Adventureworks データベースを次のクエリでバックアップします。

    ```sql
    BACKUP DATABASE Adventureworks  
    TO DISK = 'U:\Adventureworks'  
       WITH FORMAT,  
          MEDIANAME = 'Adventureworks',  
          NAME = 'Full Backup of Adventureworks';  
    ```

1. バックアップが正常に完了したら、 **SQL Management Studio**を閉じる

> [!重要]
> このラボのこの終了時に、Azure で実行されている SQL Server VM を削除しないでください。これは、ラボ 4 の Azure データベースへの移行のソースとして使用されます。

結果: これで、Azure VM 内で実行されている SQL Server 2017 への SQL Server データベースの正常な移行が完了しました。